<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  
    <title>IPSEC/L2TP VPN on a Raspberry Pi running Arch Linux - Keith Smiley</title>
  

    <meta name="author" content="Keith Smiley">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">

    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon">

    <link rel="stylesheet" type="text/css" href="/css/style.css" title="default">
  </head>
  <body>
    <section class="container">
      <div id="masthead">
        <h1>
          <a href="/">Keith Smiley</a>
          | <a href="https://www.keith.so">About</a>
          | <a href="/atom.xml">RSS</a>
          | <a rel="me" href="https://mastodon.social/@SmileyKeith">Mastodon</a>
        </h1>
      </div>

      <section class="content">
        <article>
  <header class="seven columns">
    
      <h1 class="title">IPSEC/L2TP VPN on a Raspberry Pi running Arch Linux</h1>
    
    <p class="date">
      <time datetime="2014-01-27 20:49:00 -0800" pubdate="pubdate">
        27 Jan 2014
      </time>
      <a class="permalink" title="Permalink" href="/2014/01/27/ipsec-l2tp-vpn-on-a-raspberry-pi-running-arch-linux/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>After you buy a Raspberry Pi, or two, you need to figure out what to use them
for. While you'll get a ton of <em>interesting</em> ideas from Googling "uses for a
Raspberry Pi," I didn't particularly find them any more than a <a href="http://arstechnica.com/information-technology/2012/12/10-raspberry-pi-creations-that-show-how-amazing-the-tiny-pc-can-be/">thought
exercise</a>.
Making a VPN stood out as an actually useful configuration.</p>

<p>Originally when I got my (accidentally chosen) Model A, I spent a little
while going through <a href="http://willitscript.com/post/40357408648/using-your-pi-as-a-l2tp-vpn-server">this
guide</a>
using Raspbian. That seemed to work fine until I recently purchased a
Model B to replace it and couldn't reproduce the configuration. I
decided to write the steps that I was finally able to use to get a
functional VPN running on Arch Linux.</p>

<p>I started out by following <a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_on_a_Raspberry_Pi_with_Arch_Linux.html">this
guide</a>
hoping that it would get me a functioning VPN without too much work.  Most of
this setup will be based on that article with some tweaks for what I had to do
to make the settings stick.  Unfortunately while it worked after the setup the
configuration did not persist after restart.  For this configuration, like I
said earlier, I wanted to use the ARM version of Arch Linux rather than
Raspbian for the install. You can download the Raspberry Pi compatible Arch
image from their <a href="http://www.raspberrypi.org/downloads">downloads page</a>. I'm
not sure I would recommend Arch for people who haven't installed it before or
at least gotten through their <a href="https://wiki.archlinux.org/index.php/Beginners'_Guide">Beginners'
Guide</a>. The ARM Image,
like the normal image, doesn't come with a GUI, perfect for this use of the Pi.</p>

<p>I'm not going to bother with making sure this works before restarting, since
that doesn't seem like much of an issue with actual usage (although you can
just run the scripts we create and it should work fine). I wouldn't recommend
doing much configuration before doing this intial setup. I did this the first
time and after an hour of configuration my VPN did not work correctly, I ended
up nuking the work I had done and starting over.</p>

<p>Start by installing the necessary components:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pacman -Sy openswan xl2tpd ppp lsof python2
</code></pre></div></div>

<p>You need to do some configuration of the firewall and redirects:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.all.accept_redirects = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.all.send_redirects = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.default.rp_filter = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.default.accept_source_route = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.default.send_redirects = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.icmp_ignore_bogus_error_responses = 1"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf</code></pre></figure>

<p>To make these settings persist we need to create a script that gets launched by
systemd each time we restart the system. As recommended in the original
article, and being a <a href="http://brew.sh/">Homebrew</a> user I created the script in
<code class="language-plaintext highlighter-rouge">/usr/local/bin/vpn-boot.sh</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/bash</span>

iptables <span class="nt">--table</span> nat <span class="nt">--append</span> POSTROUTING <span class="nt">--jump</span> MASQUERADE

<span class="k">for </span>vpn <span class="k">in</span> /proc/sys/net/ipv4/conf/<span class="k">*</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">echo </span>0 <span class="o">&gt;</span> <span class="nv">$vpn</span>/accept_redirects<span class="p">;</span>
    <span class="nb">echo </span>0 <span class="o">&gt;</span> <span class="nv">$vpn</span>/send_redirects<span class="p">;</span>
<span class="k">done

</span>sysctl <span class="nt">-p</span></code></pre></figure>

<p>There are a few things that differ here to the original article. First
the hashbang path was changed since the default $PATH on the ARM version
of Arch didn't include <code class="language-plaintext highlighter-rouge">/bin</code>. I would run <code class="language-plaintext highlighter-rouge">which -a bash</code> on your
install to make sure this works for you. This obviously doesn't have
to be changed, but I think it's better in the long run. I also added
<code class="language-plaintext highlighter-rouge">sysctl -p</code> since these settings didn't seemed to be applied otherwise.
Then you must make this script executable with something like:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">chmod</span> +x /usr/local/bin/vpn-boot.sh</code></pre></figure>

<p>Since Arch uses systemd to this script has to be launched by creating a
service to be ran through systemd. You can create this file in
<code class="language-plaintext highlighter-rouge">/etc/systemd/system/vpnboot.service</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=VPN Settings at boot
After=netctl@eth0.service
Before=openswan.service xl2tpd.service

[Service]
ExecStart=/usr/local/bin/vpn-boot.sh

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>I added a few things here as well. I wanted to make sure that the boot command
would launch after the network settings had been established and before the
other VPN software was launched. I'm not sure how many of these changes would
be required for systemd to do what I wanted it to but the order really seemed
to matter for here. After you create this service enable it within systemd
with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable vpnboot.service
</code></pre></div></div>

<p>I also made some changes to <code class="language-plaintext highlighter-rouge">/etc/ipsec.conf</code> (note the comments in the
default file for some more info on these settings):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config setup
  dumpdir=/var/run/pluto/
  nat_traversal=yes
  virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:25.0.0.0/8,%v6:fd00::/8,%v6:fe80::/10
  oe=off
  protostack=netkey
  plutoopts="--interface=eth0"

conn L2TP-PSK-noNAT
  authby=secret
  pfs=no
  auto=add
  keyingtries=3
  ikelifetime=8h
  keylife=1h
  type=transport
  # Your server's IP (I used my internal IP, assuming you're using NAT)
  left=172.16.1.1
  leftprotoport=17/1701
  right=%any
  rightprotoport=17/%any
  rightsubnetwithin=0.0.0.0/0
  dpddelay=10
  dpdtimeout=20
  dpdaction=clear
</code></pre></div></div>

<p>Then for the <code class="language-plaintext highlighter-rouge">/etc/ipsec.secrets</code> (use the same server IP address):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%SameIP%  %any: PSK "super random key"
</code></pre></div></div>

<p>The make systemd start openswan on boot as well:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable openswan
</code></pre></div></div>

<p>I also edited the openswan service file in
<code class="language-plaintext highlighter-rouge">/etc/systemd/system/multi-user.target.wants/openswan.service</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Openswan daemon
After=netctl@eth0.service vpnboot.service
Before=xl2tpd.service

[Service]
Type=forking
ExecStart=/usr/lib/systemd/scripts/ipsec --start
ExecStop=/usr/lib/systemd/scripts/ipsec --stop
ExecReload=/usr/lib/systemd/scripts/ipsec --restart
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>As you can see I removed the original network dependency and added a new
dependency of <a href="https://wiki.archlinux.org/index.php/Netctl">netctl's</a>
default network interface (we haven't enabled this yet).</p>

<p>Next for <code class="language-plaintext highlighter-rouge">/etc/xl2tpd/xl2tpd.conf</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[global]
ipsec saref = yes
saref refinfo = 30

[lns default]
ip range = 172.16.1.70-172.16.1.89
local ip = 172.16.1.1
require authentication = yes
ppp debug = yes
pppoptfile = /etc/ppp/options.xl2tpd
length bit = yes
unix authentication = yes
</code></pre></div></div>

<p>Where <code class="language-plaintext highlighter-rouge">local ip</code> is the server's ip and the <code class="language-plaintext highlighter-rouge">ip range</code> is the range of
IP addresses you want to use for VPN clients. You need to enable this
service too with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable xl2tpd
</code></pre></div></div>

<p>I also edited the systemd file for xl2tpd at
<code class="language-plaintext highlighter-rouge">/etc/systemd/system/multi-user.target.wants/xl2tpd.service</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Level 2 Tunnel Protocol Daemon (L2TP)
After=syslog.target netctl@eth0.service openswan.service
Requires=openswan.service

[Service]
Type=simple
PIDFile=/run/xl2tpd/xl2tpd.pid
ExecStart=/usr/bin/xl2tpd -D
Restart=on-abort

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>The other guide also recommends creating the xl2tpd control folder with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /var/run/xl2tpd/
</code></pre></div></div>

<p>Now we need to create/edit <code class="language-plaintext highlighter-rouge">/etc/ppp/options.xl2tpd</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipcp-accept-local
ipcp-accept-remote
ms-dns 8.8.8.8
ms-dns 8.8.4.4
auth
mtu 1200
mru 1000
crtscts
hide-password
modem
name l2tpd
proxyarp
lcp-echo-interval 30
lcp-echo-failure 4
login
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">/etc/pam.d/ppp</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auth    required        pam_nologin.so
auth    required        pam_unix.so
account required        pam_unix.so
session required        pam_unix.so
</code></pre></div></div>

<p>And <code class="language-plaintext highlighter-rouge">/etc/ppp/pap-secrets</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*       l2tpd           ""              *
</code></pre></div></div>

<p>If you'd like you can also restrict the users accounts that can access
the vpn. This way you can separate your login user from your VPN users
who can have much stronger passwords. You'd do that in your
<code class="language-plaintext highlighter-rouge">/etc/ppp/pap-secrets</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vpnuser   l2tpd         ""              *
</code></pre></div></div>

<p>To enable the startup of the default netctl eth0 interface you need to
run:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netctl enable eth0
</code></pre></div></div>

<p>You'll probably want to disable any other netctl systemd functions that are
enabled by default. Check <code class="language-plaintext highlighter-rouge">/etc/systemd/system/mutli-user.target.wants</code> to for
other <code class="language-plaintext highlighter-rouge">netctl</code> profiles.</p>

<p>So at this point you should be able to enable VPN clients using the
super secret keys you enabled before and the username and passwords
you've created previously. You can create new users for specifically VPN
usage with something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>useradd -s /sbin/nologin vpnuser
</code></pre></div></div>

<p>This disallows users from being able to be used for login which is probably
more secure for your VPN (although not required). For testing you can use the
root/root defualt user and a less secure key, although you should <em>definitely</em>
change these before allowing access to the outside world.</p>

<h3 id="troubleshooting">Troubleshooting</h3>

<p>Undoubtedly you'll have to deal with something that doesn't work exactly
how my setup works. The most useful things to seeing what was happening
were these:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netstat -tulpan
systemctl status openswan
systemctl status xl2tpd
journalctl -f
</code></pre></div></div>

<p>You can glance at some of the other guides to see what should be going
on. You probably shouldn't see any red in the <code class="language-plaintext highlighter-rouge">openswan</code> status and you
should see ports open under <code class="language-plaintext highlighter-rouge">pluto</code> with netstat. You can check out the
<a href="http://linux.die.net/man/5/ipsec.conf">ipsec manpage</a> or the <a href="https://github.com/xelerance/Openswan/wiki/L2tp-ipsec-configuration-using-openswan-and-xl2tpd">openswan
wiki
page</a>
for a little more information on some of the settings. Also I used <a href="http://www.freedesktop.org/software/systemd/man/systemd.service.html">this
page</a>
for some more info on how systemd settings work. Please let me know if
there's anything here that could be done easier/better for this
configuration.</p>

  </div>
</article>

      </section>
    </section>
  </body>
</html>
