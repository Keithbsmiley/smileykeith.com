<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  
    <title>Editing rpaths for _InternalSwiftSyntaxParser - Keith Smiley</title>
  

    <meta name="author" content="Keith Smiley">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">

    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon">

    <link rel="stylesheet" type="text/css" href="/css/style.css" title="default">
  </head>
  <body>
    <section class="container">
      <div id="masthead">
        <h1>
          <a href="/">Keith Smiley</a>
          | <a href="https://www.keith.so">About</a>
          | <a href="/atom.xml">RSS</a>
        </h1>
      </div>

      <section class="content">
        <article>
  <header class="seven columns">
    
      <h1 class="title">Editing rpaths for _InternalSwiftSyntaxParser</h1>
    
    <p class="date">
      <time datetime="2021-03-03 19:48:00 -0800" pubdate="pubdate">
        03 Mar 2021
      </time>
      <a class="permalink" title="Permalink" href="/2021/03/03/editing-rpaths/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>One of the issues with shipping a tool that depends on
<a href="https://github.com/apple/swift-syntax">SwiftSyntax</a> is that it depends
on a dynamic library that is provided with Xcode called
<code class="highlighter-rouge">_InternalSwiftSyntaxParser</code>. This library provides some of Swift's
logic for how to parse Swift code. When you run a command line tool that
was built with a different version of Xcode than what you have installed
locally, you hit this issue:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;unknown&gt;:0:0: error: The loaded '_InternalSwiftSyntaxParser' library is from a toolchain that is not compatible with this version of SwiftSyntax
</code></pre></div></div>

<p>Ideally, this library would be statically linked to your executable (and
I'm hoping we can find <a href="https://github.com/apple/swift/pull/36151">a
solution</a> to this) so you
would no longer have to worry about this. In the meantime, we can work
around this issue by shipping the version of the library from Xcode
alongside your executable, and loading that instead. This will increase
your distribution archive's size, but make it easier to support multiple
versions of Xcode at once.</p>

<p>The key to this workaround relies on how
<a href="https://keith.github.io/xcode-man-pages/dyld.1.html"><code class="highlighter-rouge">dyld</code></a> works.
<code class="highlighter-rouge">dyld</code> is responsible for loading the dynamic libraries your binary
depends on. First, it's useful for you to see what libraries you depend
on with
<a href="https://keith.github.io/xcode-man-pages/llvm-otool.1.html"><code class="highlighter-rouge">otool</code></a>.
For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% otool -L ./.build/debug/drstring-cli
./.build/debug/drstring-cli:
  ...
  /usr/lib/swift/libswiftObjectiveC.dylib (compatibility version 1.0.0, current version 1.0.0, weak)
  /usr/lib/swift/libswiftXPC.dylib (compatibility version 1.0.0, current version 1.1.0, weak)
  @rpath/lib_InternalSwiftSyntaxParser.dylib (compatibility version 1.0.0, current version 17013.0.0)
</code></pre></div></div>

<p>Here you can see many libraries are directly referenced with their
absolute paths while <code class="highlighter-rouge">lib_InternalSwiftSyntaxParser.dylib</code>, the library
we're specifically interested in, is referenced via a
<a href="https://en.wikipedia.org/wiki/Rpath"><code class="highlighter-rouge">rpath</code></a>. You can run this command
to see your binary's <code class="highlighter-rouge">rpaths</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% otool -l ./.build/debug/drstring-cli \
  | grep -A2 LC_RPATH \
  | grep "^\s*path" | cut -d " " -f 11
@loader_path
/Applications/Xcode-12.4.0.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/macosx
</code></pre></div></div>

<p>Here we can see that <code class="highlighter-rouge">dyld</code> is instructed to look in 2 directories to
find <code class="highlighter-rouge">lib_InternalSwiftSyntaxParser.dylib</code>. First, it looks in the
directory specified by <code class="highlighter-rouge">@loader_path</code>, which in our case is likely
irrelevant since it is the directory that contains our executable. Then,
it looks inside a directory within my absolute path to Xcode (which
isn't very portable), which we can see this includes the library we
expect:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% ls /Applications/Xcode-12.4.0.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/macosx
layouts-x86_64.yaml                  libswiftCompatibilityDynamicReplacements.a
lib_InternalSwiftSyntaxParser.dylib  libswiftRemoteMirror42.dylib
libswiftCompatibility50.a            libswiftRemoteMirrorLegacy.dylib
libswiftCompatibility51.a            prebuilt-modules
</code></pre></div></div>

<p>Given this information, our goal is to replace the default locations
<code class="highlighter-rouge">dyld</code> searches, and replace those with the directory we want. There are
a few ways we can do this, but first we need to decide what directory we
will ship the library in. Typically, the directory structure for a
command line tool that includes a dynamic library looks something
like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;prefix&gt;
├── bin
│   └── drstring-cli
└── lib
    └── lib_InternalSwiftSyntaxParser.dylib
</code></pre></div></div>

<p>We can use this for our example. First, we need to copy the library
from Xcode using (this might change with future Xcode releases):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp "$(xcode-select -p)"/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/macosx/lib_InternalSwiftSyntaxParser.dylib .
</code></pre></div></div>

<p>Then, using
<a href="https://keith.github.io/xcode-man-pages/install_name_tool.1.html"><code class="highlighter-rouge">install_name_tool</code></a>,
we can edit the <code class="highlighter-rouge">rpaths</code> in our binary. In this case, since we only have
2 <code class="highlighter-rouge">rpaths</code>, and neither of them are what we want, lets delete them both:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% install_name_tool \
  -delete_rpath @loader_path \
  -delete_rpath /Applications/Xcode-12.4.0.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/swift/macosx \
  bin/drstring-cli
</code></pre></div></div>

<p>Now, when we run our binary, we see it crashes immediately because it
cannot find  the libraries it needs:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% bin/drstring-cli
dyld: Library not loaded: @rpath/lib_InternalSwiftSyntaxParser.dylib
  Referenced from: /Users/ksmiley/dev/DrString/bin/drstring-cli
  Reason: image not found
</code></pre></div></div>

<p>At this point we have 2 options. We can either launch our binary with
some special environment variables that <code class="highlighter-rouge">dyld</code> reads, or encode the
<code class="highlighter-rouge">rpath</code> we want into the binary. Since adding the <code class="highlighter-rouge">rpath</code> to the binary
is destructive, lets try the environment variable approach first as an
example. Using <code class="highlighter-rouge">DYLD_LIBRARY_PATH</code> we can instruct <code class="highlighter-rouge">dyld</code> to discover
the libraries we want:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% DYLD_LIBRARY_PATH=lib bin/drstring-cli
OVERVIEW: A Swift docstring linter, formatter, nitpicky assistant...
...
</code></pre></div></div>

<p>There is also <code class="highlighter-rouge">DYLD_FALLBACK_LIBRARY_PATH</code>, which unlike
<code class="highlighter-rouge">DYLD_LIBRARY_PATH</code>, has a default of <code class="highlighter-rouge">/usr/local/lib:/usr/lib</code>. This
means if your library doesn't exist in the binary's <code class="highlighter-rouge">rpaths</code>, but then
happens to be in <code class="highlighter-rouge">/usr/local/lib</code>, it will still run as expected. This
is useful to know, because <a href="https://brew.sh/">homebrew</a> installs
libraries to <code class="highlighter-rouge">/usr/local/lib</code> on Intel based Macs. This can be
surprising if you install an unrelated tool that depends on the same
library and then your binary discovers this unrelated installation when
you don't want it to. If you want to disable this fallback, you can set
the value to <code class="highlighter-rouge">/dev/null</code>. In our example, using
<code class="highlighter-rouge">DYLD_FALLBACK_LIBRARY_PATH</code> results in same behavior:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% DYLD_FALLBACK_LIBRARY_PATH=lib bin/drstring-cli
OVERVIEW: A Swift docstring linter, formatter, nitpicky assistant...
...
</code></pre></div></div>

<p>Instead of setting environment variables every time we run the binary,
we can edit our binary to instruct <code class="highlighter-rouge">dyld</code> to search the correct
directory. Again, we use <code class="highlighter-rouge">install_name_tool</code> for this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% install_name_tool -add_rpath @executable_path/../lib bin/drstring-cli
</code></pre></div></div>

<p>In this case we rely on a relative path, based on the executable's
current path, to find our library. Now, as long as we ship the library
alongside our binary, we can run it without setting any environment
variables.</p>

<p>To use this method with Swift Package Manager you'll have to run a
post-processing script that alters your <code class="highlighter-rouge">rpaths</code> using what we've
learned.</p>

<p>Overall this is more work than if we could produce a statically linked
binary, but it's better than having to force your users on to a specific
version of Xcode.</p>

  </div>
</article>

      </section>
    </section>
  </body>
</html>
