<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
  
    <title>Locking Xcode versions in bazel - Keith Smiley</title>
  

    <meta name="author" content="Keith Smiley">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">

    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon">

    <link rel="stylesheet" type="text/css" href="/css/style.css" title="default">
  </head>
  <body>
    <section class="container">
      <div id="masthead">
        <h1>
          <a href="/">Keith Smiley</a>
          | <a href="https://www.keith.so">About</a>
          | <a href="/atom.xml">RSS</a>
          | <a rel="me" href="https://mastodon.social/@SmileyKeith">Mastodon</a>
        </h1>
      </div>

      <section class="content">
        <article>
  <header class="seven columns">
    
      <h1 class="title">Locking Xcode versions in bazel</h1>
    
    <p class="date">
      <time datetime="2021-03-08 08:40:00 -0800" pubdate="pubdate">
        08 Mar 2021
      </time>
      <a class="permalink" title="Permalink" href="/2021/03/08/locking-xcode-in-bazel/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>When using <a href="https://www.bazel.build">bazel</a> on a team, one of the
things you quickly want to do is stand up a <a href="https://docs.bazel.build/versions/master/remote-caching.html">remote
cache</a>.
This allows bazel to download build artifacts instead of spending CPU
cycles reproducing things that have already been built by someone else.</p>

<p>In order for bazel to guarantee that downloading the artifacts instead
of building them will produce the same results, it must ensure that all
the inputs of your build are the same as a previous build.<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> For macOS
and iOS builds bazel's inputs include the version of Xcode you're using.
This means if developers on your team use different versions of Xcode,
they cannot share the same build cache.</p>

<p>Bazel discovers your currently installed Xcode versions by running
<a href="https://github.com/bazelbuild/bazel/blob/cd6724deb7dad05c477425fb09eff613659a5b3f/tools/osx/xcode_locator.m"><code class="language-plaintext highlighter-rouge">xcode_locator</code></a>,
and then
<a href="https://github.com/bazelbuild/bazel/blob/cd6724deb7dad05c477425fb09eff613659a5b3f/tools/osx/xcode_configure.bzl">generating</a>
a <code class="language-plaintext highlighter-rouge">BUILD</code> file that contains an entry for every version you currently
have installed. The result looks something like this:<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup></p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xcode_version</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"version12_4_0_12D4e"</span><span class="p">,</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">"12.4.0.12D4e"</span><span class="p">,</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s">"12.4.0"</span><span class="p">,</span> <span class="s">"12.4"</span><span class="p">,</span> <span class="s">"12.4.0.12D4e"</span><span class="p">],</span>
    <span class="n">default_ios_sdk_version</span> <span class="o">=</span> <span class="s">"14.4"</span><span class="p">,</span>
    <span class="n">default_tvos_sdk_version</span> <span class="o">=</span> <span class="s">"14.3"</span><span class="p">,</span>
    <span class="n">default_macos_sdk_version</span> <span class="o">=</span> <span class="s">"11.1"</span><span class="p">,</span>
    <span class="n">default_watchos_sdk_version</span> <span class="o">=</span> <span class="s">"7.2"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">xcode_version</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"version12_2_0_12B45b"</span><span class="p">,</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">"12.2.0.12B45b"</span><span class="p">,</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s">"12.2.0"</span><span class="p">,</span> <span class="s">"12"</span><span class="p">,</span> <span class="s">"12.2"</span><span class="p">,</span> <span class="s">"12.2.0.12B45b"</span><span class="p">],</span>
    <span class="n">default_ios_sdk_version</span> <span class="o">=</span> <span class="s">"14.2"</span><span class="p">,</span>
    <span class="n">default_tvos_sdk_version</span> <span class="o">=</span> <span class="s">"14.2"</span><span class="p">,</span>
    <span class="n">default_macos_sdk_version</span> <span class="o">=</span> <span class="s">"11.0"</span><span class="p">,</span>
    <span class="n">default_watchos_sdk_version</span> <span class="o">=</span> <span class="s">"7.1"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">xcode_config</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"host_xcodes"</span><span class="p">,</span>
    <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="s">":version12_4_0_12D4e"</span><span class="p">,</span> <span class="s">":version12_2_0_12B45b"</span><span class="p">],</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s">":version12_4_0_12D4e"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>To fetch the contents of this file on your machine you can run:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>bazel-<span class="si">$(</span><span class="nb">basename</span> <span class="nv">$PWD</span><span class="si">)</span>/external/local_config_xcode/BUILD
</code></pre></div></div>

<p>In order to enforce developers use the same version, you can short
circuit bazel's Xcode discovery and instead reference a local
<a href="https://docs.bazel.build/versions/master/build-ref.html#targets">target</a>
that you provide.<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup></p>

<p>To do this, you can setup your target in the <code class="language-plaintext highlighter-rouge">BUILD</code> file at the root of
your project (or somewhere else if you'd prefer). Using the contents
from the example above, but only including the Xcode versions you want
to support, it will contain:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xcode_version</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"version12_4_0_12D4e"</span><span class="p">,</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">"12.4.0.12D4e"</span><span class="p">,</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s">"12.4.0"</span><span class="p">,</span> <span class="s">"12.4"</span><span class="p">,</span> <span class="s">"12.4.0.12D4e"</span><span class="p">],</span>
    <span class="n">default_ios_sdk_version</span> <span class="o">=</span> <span class="s">"14.4"</span><span class="p">,</span>
    <span class="n">default_tvos_sdk_version</span> <span class="o">=</span> <span class="s">"14.3"</span><span class="p">,</span>
    <span class="n">default_macos_sdk_version</span> <span class="o">=</span> <span class="s">"11.1"</span><span class="p">,</span>
    <span class="n">default_watchos_sdk_version</span> <span class="o">=</span> <span class="s">"7.2"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">xcode_config</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"host_xcodes"</span><span class="p">,</span>
    <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="s">":version12_4_0_12D4e"</span><span class="p">],</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s">":version12_4_0_12D4e"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Then you can add this to your
<a href="https://docs.bazel.build/versions/master/guide.html#bazelrc-the-bazel-configuration-file"><code class="language-plaintext highlighter-rouge">.bazelrc</code></a>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>build --xcode_version_config=//:host_xcodes
</code></pre></div></div>

<p>This way if a developer tries to build with a version of Xcode that is
not explicitly supported, they see this error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ERROR: /.../BUILD.bazel:31:11: Compiling something failed: I/O exception during sandboxed execution: Running '/.../xcode-locator 12.4.0.12D4e' failed with code 1.
This most likely indicates that xcode version 12.4.0.12D4e is not available on the host machine.
</code></pre></div></div>

<p>This is a simple solution <em>if</em> you only want to support a single version
of Xcode at once. Often it's useful to support multiple Xcode versions
for testing, even if not all versions will get cache hits. In this
case, one solution is to include multiple versions in your <code class="language-plaintext highlighter-rouge">BUILD</code>
file:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">xcode_version</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"version12_4_0_12D4e"</span><span class="p">,</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">"12.4.0.12D4e"</span><span class="p">,</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s">"12D4e"</span><span class="p">],</span>
    <span class="n">default_ios_sdk_version</span> <span class="o">=</span> <span class="s">"14.4"</span><span class="p">,</span>
    <span class="n">default_tvos_sdk_version</span> <span class="o">=</span> <span class="s">"14.3"</span><span class="p">,</span>
    <span class="n">default_macos_sdk_version</span> <span class="o">=</span> <span class="s">"11.1"</span><span class="p">,</span>
    <span class="n">default_watchos_sdk_version</span> <span class="o">=</span> <span class="s">"7.2"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">xcode_version</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"version12_2_0_12B45b"</span><span class="p">,</span>
    <span class="n">version</span> <span class="o">=</span> <span class="s">"12.2.0.12B45b"</span><span class="p">,</span>
    <span class="n">aliases</span> <span class="o">=</span> <span class="p">[</span><span class="s">"12B45b"</span><span class="p">],</span>
    <span class="n">default_ios_sdk_version</span> <span class="o">=</span> <span class="s">"14.2"</span><span class="p">,</span>
    <span class="n">default_tvos_sdk_version</span> <span class="o">=</span> <span class="s">"14.2"</span><span class="p">,</span>
    <span class="n">default_macos_sdk_version</span> <span class="o">=</span> <span class="s">"11.0"</span><span class="p">,</span>
    <span class="n">default_watchos_sdk_version</span> <span class="o">=</span> <span class="s">"7.1"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">xcode_config</span><span class="p">(</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">"host_xcodes"</span><span class="p">,</span>
    <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="s">":version12_4_0_12D4e"</span><span class="p">,</span> <span class="s">":version12_2_0_12B45b"</span><span class="p">],</span>
    <span class="n">default</span> <span class="o">=</span> <span class="s">":version12_4_0_12D4e"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Which is very similar to our first example, except we replaced the
<code class="language-plaintext highlighter-rouge">aliases</code> with the build numbers from each version. This is a perfect
unique value to differentiate between multiple versions during the Xcode
beta cycle. Now we can explicitly pass the
<a href="https://docs.bazel.build/versions/4.0.0/command-line-reference.html#flag--xcode_version"><code class="language-plaintext highlighter-rouge">xcode_version</code></a>
argument with the build number you want to use. You can retrieve the
build number from your current Xcode version like this:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% xcodebuild <span class="nt">-version</span> | <span class="nb">tail</span> <span class="nt">-1</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s2">" "</span> <span class="nt">-f3</span>
12D4e
</code></pre></div></div>

<p>Using this method you can support multiple versions of Xcode, while
still respecting the user's <code class="language-plaintext highlighter-rouge">xcode-select</code> value (or <code class="language-plaintext highlighter-rouge">DEVELOPER_DIR</code>
environment variable).</p>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p>Debugging remote cache misses is something you'll need to get used
  to doing. <a href="https://docs.bazel.build/versions/master/remote-caching-debug.html">This documentation</a>
  is very helpful. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p>This example doesn't include the remote execution configuration,
  but it works similarity <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p>This also improves repository setup time. Otherwise it increases
  with the number of Xcode versions you have installed. <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

  </div>
</article>

      </section>
    </section>
  </body>
</html>
