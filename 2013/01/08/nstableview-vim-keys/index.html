<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
  
    <title>NSTableView vim keys - Keith Smiley</title>
  

    <meta name="author" content="Keith Smiley">
    <link rel="author" href="https://plus.google.com/114321628813035573740/">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">

    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon">

    <!-- Thank you http://mathiasbynens.be/notes/touch-icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/touchicons/apple-touch-icon-144x144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/touchicons/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/touchicons/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/images/touchicons/apple-touch-icon-precomposed.png">

    <!--[if lt IE 9]>
      <script type="text/javascript" language="Javascript" src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/css/style.css" title="default">
  </head>
  <body>
    <section class="container">
      <div id="masthead">
        <h1>
          <a href="/">Keith Smiley</a>
          - <a href="http://keith.so" title="Who is this guy?">Who?</a>
        </h1>
      </div>

      <section class="content">
        
<article>

  <header class="seven columns">
    
      <h2>NSTableView vim keys</h2>
    
    <p>
      <time datetime="2013-01-08 16:19:00 -0800" pubdate="pubdate">
        08 Jan 2013
      </time>
      <a class="permalink" title="Permalink" href="/2013/01/08/nstableview-vim-keys/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>I'm currently working on a OS X application that uses a few different NSTableViews to display user data. I was testing them out a bit to make sure multiple deletions worked correctly from my database and I found myself pressing 'j' and 'k' to try and move down and up. I decided it would be pretty cool to implement those two vim shortcuts into my table view just in case anyone else thinks like me.</p>

<p>This functionality already exists in <a href="http://www.potionfactory.com/thehitlist/">The Hit List</a> an awesome GTD app that has a lot of baggage with me, and I'm sure it exists in other applications as well.</p>

<p>In my <code>NSTableView</code> subclass' <code>keyDown:</code> method I tried a few things.</p>

<p>Attempt 1: First I tried to re implement the functionality myself. In retrospect this doesn't make any sense but at first it was pretty simple. It looked something like this.</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="bp">NSUInteger</span> <span class="n">flags</span> <span class="o">=</span> <span class="p">[</span><span class="n">theEvent</span> <span class="n">modifierFlags</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">NSDeviceIndependentModifierFlagsMask</span><span class="p">;</span>
<span class="bp">NSNumber</span> <span class="o">*</span><span class="n">shiftPressed</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NSShiftKeyMask</span><span class="p">);</span>
 
<span class="k">if</span> <span class="p">([</span><span class="n">theEvent</span> <span class="n">keyCode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">38</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// j</span>
    <span class="bp">NSUInteger</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">self</span> <span class="n">selectedRowIndexes</span><span class="p">]</span> <span class="n">lastIndex</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">shiftPressed</span> <span class="n">boolValue</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">selectRowIndexes</span><span class="p">:[</span><span class="bp">NSIndexSet</span> <span class="nl">indexSetWithIndex</span><span class="p">:</span><span class="n">index</span><span class="p">]</span> <span class="nl">byExtendingSelection</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">selectRowIndexes</span><span class="p">:[</span><span class="bp">NSIndexSet</span> <span class="nl">indexSetWithIndex</span><span class="p">:</span><span class="n">index</span><span class="p">]</span> <span class="nl">byExtendingSelection</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="n">theEvent</span> <span class="n">keyCode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// k</span>
    <span class="bp">NSUInteger</span> <span class="n">index</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">self</span> <span class="n">selectedRowIndexes</span><span class="p">]</span> <span class="n">lastIndex</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">shiftPressed</span> <span class="n">boolValue</span><span class="p">])</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">selectRowIndexes</span><span class="p">:[</span><span class="bp">NSIndexSet</span> <span class="nl">indexSetWithIndex</span><span class="p">:</span><span class="n">index</span><span class="p">]</span> <span class="nl">byExtendingSelection</span><span class="p">:</span><span class="nb">YES</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">[</span><span class="nb">self</span> <span class="nl">selectRowIndexes</span><span class="p">:[</span><span class="bp">NSIndexSet</span> <span class="nl">indexSetWithIndex</span><span class="p">:</span><span class="n">index</span><span class="p">]</span> <span class="nl">byExtendingSelection</span><span class="p">:</span><span class="nb">NO</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>


<p>The issue with this is the way <code>NSTableView</code> typically expands it's selection. I think of it as a pivot point where you start. Then you go up and down relative to that point. So if you start at index 2 and go down till index 4, you should have 2 rows selected. Then when you go back up you should deselect the rows and indexes 3 and 4 and select the rows and index 1 and 0. At this point I realized it was more difficult than I realized at first and went in search on another solution.</p>

<p>Attempt 2: The next solution I discovered used the <a href="https://developer.apple.com/library/mac/#documentation/Carbon/Reference/QuartzEventServicesRef/Reference/reference.html">Quartz Event Services</a> APIs.</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">([</span><span class="n">theEvent</span> <span class="n">keyCode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">38</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// The letter &#39;j&#39;</span>
    <span class="n">CGEventRef</span> <span class="n">e</span> <span class="o">=</span> <span class="n">CGEventCreateKeyboardEvent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">CGKeyCode</span><span class="p">)</span><span class="mi">125</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">CGEventPost</span><span class="p">(</span><span class="n">kCGSessionEventTap</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="n">CFRelease</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="n">theEvent</span> <span class="n">keyCode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// The letter &#39;k&#39;</span>
    <span class="n">CGEventRef</span> <span class="n">e</span> <span class="o">=</span> <span class="n">CGEventCreateKeyboardEvent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">CGKeyCode</span><span class="p">)</span><span class="mi">126</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
    <span class="n">CGEventPost</span><span class="p">(</span><span class="n">kCGSessionEventTap</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
    <span class="n">CFRelease</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>


<p>This solution worked perfectly, at first. This mainly emulates a key press with a different key code. So as you can see I was catching j and k and spitting them out as down and up. I spent a few minutes testing this before I remembered that I had sandboxing disabled so I could more easily delete my application support folder while messing with my Core Data stack. There went that solution.</p>

<p>Attempt 3: Before I used the weird <code>CGEventRef</code> solution I tried to create my own <code>NSEvent</code> passing it all the same attributes from the original event (all this code is being used in the <code>keyDown:</code> function of my subclass) but I couldn't figure out how to get the correct character string for the up and down arrows. I typically use <a href="http://manytricks.com/keycodes/">Key Codes</a> to get all the possible information you could want about each key you press. But for some keys, including the arrow keys, it returns garbage for the character code. Then I discovered <a href="http://stackoverflow.com/a/4434934/902968">this answer</a> on StackOverflow where there is a brief mention of <code>NSUpArrowFunctionKey</code>. With that I came up with this.</p>

<div class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="k">if</span> <span class="p">([</span><span class="n">theEvent</span> <span class="n">keyCode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">38</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// j</span>
    <span class="kt">unichar</span> <span class="n">down</span> <span class="o">=</span> <span class="n">NSDownArrowFunctionKey</span><span class="p">;</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">downString</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithCharacters</span><span class="p">:</span><span class="o">&amp;</span><span class="n">down</span> <span class="nl">length</span><span class="p">:</span><span class="mi">1</span><span class="p">];</span>
    <span class="bp">NSEvent</span> <span class="o">*</span><span class="n">newEvent</span> <span class="o">=</span><span class="p">[</span><span class="bp">NSEvent</span> <span class="nl">keyEventWithType</span><span class="p">:</span><span class="n">NSKeyDown</span>
                                        <span class="nl">location</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">locationInWindow</span>
                                   <span class="nl">modifierFlags</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">modifierFlags</span>
                                       <span class="nl">timestamp</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">timestamp</span>
                                    <span class="nl">windowNumber</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">windowNumber</span>
                                         <span class="nl">context</span><span class="p">:</span><span class="nb">nil</span>
                                      <span class="nl">characters</span><span class="p">:</span><span class="n">downString</span>
                     <span class="nl">charactersIgnoringModifiers</span><span class="p">:</span><span class="n">downString</span>
                                       <span class="nl">isARepeat</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">isARepeat</span>
                                         <span class="nl">keyCode</span><span class="p">:</span><span class="n">down</span><span class="p">];</span>
    
    <span class="p">[</span><span class="nb">super</span> <span class="nl">keyDown</span><span class="p">:</span><span class="n">newEvent</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">([</span><span class="n">theEvent</span> <span class="n">keyCode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">40</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// k</span>
    <span class="kt">unichar</span> <span class="n">up</span> <span class="o">=</span> <span class="n">NSUpArrowFunctionKey</span><span class="p">;</span>
    <span class="bp">NSString</span> <span class="o">*</span><span class="n">upString</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSString</span> <span class="nl">stringWithCharacters</span><span class="p">:</span><span class="o">&amp;</span><span class="n">up</span> <span class="nl">length</span><span class="p">:</span><span class="mi">1</span><span class="p">];</span>
    <span class="bp">NSEvent</span> <span class="o">*</span><span class="n">newEvent</span> <span class="o">=</span><span class="p">[</span><span class="bp">NSEvent</span> <span class="nl">keyEventWithType</span><span class="p">:</span><span class="n">NSKeyDown</span>
                                        <span class="nl">location</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">locationInWindow</span>
                                   <span class="nl">modifierFlags</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">modifierFlags</span>
                                       <span class="nl">timestamp</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">timestamp</span>
                                    <span class="nl">windowNumber</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">windowNumber</span>
                                         <span class="nl">context</span><span class="p">:</span><span class="nb">nil</span>
                                      <span class="nl">characters</span><span class="p">:</span><span class="n">upString</span>
                     <span class="nl">charactersIgnoringModifiers</span><span class="p">:</span><span class="n">upString</span>
                                       <span class="nl">isARepeat</span><span class="p">:</span><span class="n">theEvent</span><span class="p">.</span><span class="n">isARepeat</span>
                                         <span class="nl">keyCode</span><span class="p">:</span><span class="n">up</span><span class="p">];</span>
    
    <span class="p">[</span><span class="nb">super</span> <span class="nl">keyDown</span><span class="p">:</span><span class="n">newEvent</span><span class="p">];</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">[</span><span class="nb">super</span> <span class="nl">keyDown</span><span class="p">:</span><span class="n">theEvent</span><span class="p">];</span>
<span class="p">}</span></code></pre></div>


<p>Not the prettiest solution I but one that seems to work perfectly, even sandboxed, to provide the expected behavior in an <code>NSTableView</code> subclass.</p>

  </div>
</article>

<div class="ten columns blogarchive">
  <a href="/archives/">Blog Archive</a>
</div>

      </section>
    </section>
  </body>
</html>
