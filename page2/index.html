<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
  
    <title>Keith Smiley</title>
  

    <meta name="author" content="Keith Smiley">
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/atom.xml">

    <link rel="icon" href="/images/favicon.png" type="image/x-icon">
    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon">

    <link rel="stylesheet" type="text/css" href="/css/style.css" title="default">
  </head>
  <body>
    <section class="container">
      <div id="masthead">
        <h1>
          <a href="/">Keith Smiley</a>
          - <a href="http://keith.so" title="Who is this guy?">Who?</a>
        </h1>
      </div>

      <section class="content">
        
<article>
  <header class="seven columns">
    
      <h2><a href="/2014/01/27/ipsec-l2tp-vpn-on-a-raspberry-pi-running-arch-linux/">IPSEC/L2TP VPN on a Raspberry Pi running Arch Linux</a></h2>
    
    <p>
      <time datetime="2014-01-27 20:49:00 -0800" pubdate="pubdate">
        27 Jan 2014
      </time>
      <a class="permalink" title="Permalink" href="/2014/01/27/ipsec-l2tp-vpn-on-a-raspberry-pi-running-arch-linux/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>After you buy a Raspberry Pi, or two, you need to figure out what to use them
for. While you'll get a ton of <em>interesting</em> ideas from Googling "uses for a
Raspberry Pi," I didn't particularly find them any more than a <a href="http://arstechnica.com/information-technology/2012/12/10-raspberry-pi-creations-that-show-how-amazing-the-tiny-pc-can-be/">thought
exercise</a>.
Making a VPN stood out as an actually useful configuration.</p>

<p>Originally when I got my (accidentally chosen) Model A, I spent a little
while going through <a href="http://willitscript.com/post/40357408648/using-your-pi-as-a-l2tp-vpn-server">this
guide</a>
using Raspbian. That seemed to work fine until I recently purchased a
Model B to replace it and couldn't reproduce the configuration. I
decided to write the steps that I was finally able to use to get a
functional VPN running on Arch Linux.</p>

<p>I started out by following <a href="https://raymii.org/s/tutorials/IPSEC_L2TP_vpn_on_a_Raspberry_Pi_with_Arch_Linux.html">this
guide</a>
hoping that it would get me a functioning VPN without too much work.  Most of
this setup will be based on that article with some tweaks for what I had to do
to make the settings stick.  Unfortunately while it worked after the setup the
configuration did not persist after restart.  For this configuration, like I
said earlier, I wanted to use the ARM version of Arch Linux rather than
Raspbian for the install. You can download the Raspberry Pi compatible Arch
image from their <a href="http://www.raspberrypi.org/downloads">downloads page</a>. I'm
not sure I would recommend Arch for people who haven't installed it before or
at least gotten through their <a href="https://wiki.archlinux.org/index.php/Beginners'_Guide">Beginners'
Guide</a>. The ARM Image,
like the normal image, doesn't come with a GUI, perfect for this use of the Pi.</p>

<p>I'm not going to bother with making sure this works before restarting, since
that doesn't seem like much of an issue with actual usage (although you can
just run the scripts we create and it should work fine). I wouldn't recommend
doing much configuration before doing this intial setup. I did this the first
time and after an hour of configuration my VPN did not work correctly, I ended
up nuking the work I had done and starting over.</p>

<p>Start by installing the necessary components:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pacman -Sy openswan xl2tpd ppp lsof python2
</code></pre></div></div>

<p>You need to do some configuration of the firewall and redirects:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s2">"net.ipv4.ip_forward = 1"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.all.accept_redirects = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.all.send_redirects = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.default.rp_filter = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.default.accept_source_route = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.conf.default.send_redirects = 0"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf
<span class="nb">echo</span> <span class="s2">"net.ipv4.icmp_ignore_bogus_error_responses = 1"</span> |  <span class="nb">tee</span> <span class="nt">-a</span> /etc/sysctl.conf</code></pre></figure>

<p>To make these settings persist we need to create a script that gets launched by
systemd each time we restart the system. As recommended in the original
article, and being a <a href="http://brew.sh/">Homebrew</a> user I created the script in
<code class="highlighter-rouge">/usr/local/bin/vpn-boot.sh</code>:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/bash</span>

iptables <span class="nt">--table</span> nat <span class="nt">--append</span> POSTROUTING <span class="nt">--jump</span> MASQUERADE

<span class="k">for </span>vpn <span class="k">in</span> /proc/sys/net/ipv4/conf/<span class="k">*</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">echo </span>0 <span class="o">&gt;</span> <span class="nv">$vpn</span>/accept_redirects<span class="p">;</span>
    <span class="nb">echo </span>0 <span class="o">&gt;</span> <span class="nv">$vpn</span>/send_redirects<span class="p">;</span>
<span class="k">done

</span>sysctl <span class="nt">-p</span></code></pre></figure>

<p>There are a few things that differ here to the original article. First
the hashbang path was changed since the default $PATH on the ARM version
of Arch didn't include <code class="highlighter-rouge">/bin</code>. I would run <code class="highlighter-rouge">which -a bash</code> on your
install to make sure this works for you. This obviously doesn't have
to be changed, but I think it's better in the long run. I also added
<code class="highlighter-rouge">sysctl -p</code> since these settings didn't seemed to be applied otherwise.
Then you must make this script executable with something like:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nb">chmod</span> +x /usr/local/bin/vpn-boot.sh</code></pre></figure>

<p>Since Arch uses systemd to this script has to be launched by creating a
service to be ran through systemd. You can create this file in
<code class="highlighter-rouge">/etc/systemd/system/vpnboot.service</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=VPN Settings at boot
After=netctl@eth0.service
Before=openswan.service xl2tpd.service

[Service]
ExecStart=/usr/local/bin/vpn-boot.sh

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>I added a few things here as well. I wanted to make sure that the boot command
would launch after the network settings had been established and before the
other VPN software was launched. I'm not sure how many of these changes would
be required for systemd to do what I wanted it to but the order really seemed
to matter for here. After you create this service enable it within systemd
with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable vpnboot.service
</code></pre></div></div>

<p>I also made some changes to <code class="highlighter-rouge">/etc/ipsec.conf</code> (note the comments in the
default file for some more info on these settings):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>config setup
  dumpdir=/var/run/pluto/
  nat_traversal=yes
  virtual_private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:25.0.0.0/8,%v6:fd00::/8,%v6:fe80::/10
  oe=off
  protostack=netkey
  plutoopts="--interface=eth0"

conn L2TP-PSK-noNAT
  authby=secret
  pfs=no
  auto=add
  keyingtries=3
  ikelifetime=8h
  keylife=1h
  type=transport
  # Your server's IP (I used my internal IP, assuming you're using NAT)
  left=172.16.1.1
  leftprotoport=17/1701
  right=%any
  rightprotoport=17/%any
  rightsubnetwithin=0.0.0.0/0
  dpddelay=10
  dpdtimeout=20
  dpdaction=clear
</code></pre></div></div>

<p>Then for the <code class="highlighter-rouge">/etc/ipsec.secrets</code> (use the same server IP address):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%SameIP%  %any: PSK "super random key"
</code></pre></div></div>

<p>The make systemd start openswan on boot as well:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable openswan
</code></pre></div></div>

<p>I also edited the openswan service file in
<code class="highlighter-rouge">/etc/systemd/system/multi-user.target.wants/openswan.service</code></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Openswan daemon
After=netctl@eth0.service vpnboot.service
Before=xl2tpd.service

[Service]
Type=forking
ExecStart=/usr/lib/systemd/scripts/ipsec --start
ExecStop=/usr/lib/systemd/scripts/ipsec --stop
ExecReload=/usr/lib/systemd/scripts/ipsec --restart
Restart=always

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>As you can see I removed the original network dependency and added a new
dependency of <a href="https://wiki.archlinux.org/index.php/Netctl">netctl's</a>
default network interface (we haven't enabled this yet).</p>

<p>Next for <code class="highlighter-rouge">/etc/xl2tpd/xl2tpd.conf</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[global]
ipsec saref = yes
saref refinfo = 30

[lns default]
ip range = 172.16.1.70-172.16.1.89
local ip = 172.16.1.1
require authentication = yes
ppp debug = yes
pppoptfile = /etc/ppp/options.xl2tpd
length bit = yes
unix authentication = yes
</code></pre></div></div>

<p>Where <code class="highlighter-rouge">local ip</code> is the server's ip and the <code class="highlighter-rouge">ip range</code> is the range of
IP addresses you want to use for VPN clients. You need to enable this
service too with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>systemctl enable xl2tpd
</code></pre></div></div>

<p>I also edited the systemd file for xl2tpd at
<code class="highlighter-rouge">/etc/systemd/system/multi-user.target.wants/xl2tpd.service</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Unit]
Description=Level 2 Tunnel Protocol Daemon (L2TP)
After=syslog.target netctl@eth0.service openswan.service
Requires=openswan.service

[Service]
Type=simple
PIDFile=/run/xl2tpd/xl2tpd.pid
ExecStart=/usr/bin/xl2tpd -D
Restart=on-abort

[Install]
WantedBy=multi-user.target
</code></pre></div></div>

<p>The other guide also recommends creating the xl2tpd control folder with:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir /var/run/xl2tpd/
</code></pre></div></div>

<p>Now we need to create/edit <code class="highlighter-rouge">/etc/ppp/options.xl2tpd</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ipcp-accept-local
ipcp-accept-remote
ms-dns 8.8.8.8
ms-dns 8.8.4.4
auth
mtu 1200
mru 1000
crtscts
hide-password
modem
name l2tpd
proxyarp
lcp-echo-interval 30
lcp-echo-failure 4
login
</code></pre></div></div>

<p><code class="highlighter-rouge">/etc/pam.d/ppp</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>auth    required        pam_nologin.so
auth    required        pam_unix.so
account required        pam_unix.so
session required        pam_unix.so
</code></pre></div></div>

<p>And <code class="highlighter-rouge">/etc/ppp/pap-secrets</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>*       l2tpd           ""              *
</code></pre></div></div>

<p>If you'd like you can also restrict the users accounts that can access
the vpn. This way you can separate your login user from your VPN users
who can have much stronger passwords. You'd do that in your
<code class="highlighter-rouge">/etc/ppp/pap-secrets</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vpnuser   l2tpd         ""              *
</code></pre></div></div>

<p>To enable the startup of the default netctl eth0 interface you need to
run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netctl enable eth0
</code></pre></div></div>

<p>You'll probably want to disable any other netctl systemd functions that are
enabled by default. Check <code class="highlighter-rouge">/etc/systemd/system/mutli-user.target.wants</code> to for
other <code class="highlighter-rouge">netctl</code> profiles.</p>

<p>So at this point you should be able to enable VPN clients using the
super secret keys you enabled before and the username and passwords
you've created previously. You can create new users for specifically VPN
usage with something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>useradd -s /sbin/nologin vpnuser
</code></pre></div></div>

<p>This disallows users from being able to be used for login which is probably
more secure for your VPN (although not required). For testing you can use the
root/root defualt user and a less secure key, although you should <em>definitely</em>
change these before allowing access to the outside world.</p>

<h3 id="troubleshooting">Troubleshooting</h3>

<p>Undoubtedly you'll have to deal with something that doesn't work exactly
how my setup works. The most useful things to seeing what was happening
were these:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netstat -tulpan
systemctl status openswan
systemctl status xl2tpd
journalctl -f
</code></pre></div></div>

<p>You can glance at some of the other guides to see what should be going
on. You probably shouldn't see any red in the <code class="highlighter-rouge">openswan</code> status and you
should see ports open under <code class="highlighter-rouge">pluto</code> with netstat. You can check out the
<a href="http://linux.die.net/man/5/ipsec.conf">ipsec manpage</a> or the <a href="https://github.com/xelerance/Openswan/wiki/L2tp-ipsec-configuration-using-openswan-and-xl2tpd">openswan
wiki
page</a>
for a little more information on some of the settings. Also I used <a href="http://www.freedesktop.org/software/systemd/man/systemd.service.html">this
page</a>
for some more info on how systemd settings work. Please let me know if
there's anything here that could be done easier/better for this
configuration.</p>

  </div>
</article>

<article>
  <header class="seven columns">
    
      <h2><a href="/2013/09/03/iterm-theme-based-on-the-time-of-day/">iTerm theme based on the time of day</a></h2>
    
    <p>
      <time datetime="2013-09-03 10:56:00 -0700" pubdate="pubdate">
        03 Sep 2013
      </time>
      <a class="permalink" title="Permalink" href="/2013/09/03/iterm-theme-based-on-the-time-of-day/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>One of the great things about Vim's textual configuration is it's
ability to contain logic based on outside factors. For the purpose of
this post I'm referring to the ability to set your colorscheme based on
the time of day with something like
<a href="https://github.com/keith/dotfiles/blob/a34e432b59e26225ebdb05737b30729b7ea670d9/vimrc#L102-L108">this</a>.</p>

<p>Having this functionality in Vim with the
<a href="http://ethanschoonover.com/solarized">Solarized</a> theme at night really
made me want this in <a href="http://www.iterm2.com/#/section/home">iTerm</a> as
well. Unfortunately iTerm's conifguration doesn't allow anything similar
to this. The closest you get is profiles which you can assign keyboard
shortcuts to for quickly opening windows with different colorschemes.
Luckily, thanks to this <a href="https://github.com/gnachman/iTerm2/pull/10">pull
request</a> two years ago from
<a href="https://twitter.com/junkiesxl">Piet Jaspers</a>, support was added for
scripting iTerm's entire colorscheme with AppleScript. Using these
AppleScript bindings I was able to create a
<a href="https://github.com/keith/dotfiles/blob/master/scripts/itermcolors.applescript">script</a>
that changes the entire colorscheme of iTerm based on the time of day
between Solarized light and dark. As you can see the
<a href="https://github.com/keith/dotfiles/blob/master/scripts/itermcolors.applescript#L27-L49">bulk</a>
of this script is just setting different color attributes based on the
theme you want. While you could do this conversion by hand to 65535
flavored RGB, I made a
tiny Objective-C app to automate the process which is <a href="https://github.com/keith/ColorConvert">on
Github</a>. You can download
the signed binary
<a href="https://github.com/keith/ColorConvert/releases/tag/1.0">here</a>.</p>

<p>Using this newly created AppleScript I then made a zsh
<a href="https://github.com/keith/dotfiles/blob/master/functions/colorize">function</a> so that I could call <code class="highlighter-rouge">colorize</code> from anywhere to update the color scheme of the current terminal.
I also chose to do this at the end of my <code class="highlighter-rouge">.zshrc</code> <a href="https://github.com/keith/dotfiles/blob/763e6f3f2bbcd93775c70e0d9ed9878ac99896a3/zshrc#L51">here</a>.
This way everytime I open a new session my theme is automatically set.</p>

<p>If you have any input on how I could optimize this let me know.</p>

  </div>
</article>

<article>
  <header class="seven columns">
    
      <h2><a href="/2013/08/14/global-htaccess/">Global htaccess</a></h2>
    
    <p>
      <time datetime="2013-08-14 13:12:00 -0700" pubdate="pubdate">
        14 Aug 2013
      </time>
      <a class="permalink" title="Permalink" href="/2013/08/14/global-htaccess/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>When starting a new web project one of the first things I do is download
the most up to date <a href="http://html5boilerplate.com/">HTML5 Boilerplate</a>.
It provides a great starting point for the HTML you need in a project.
It also comes with an extremely complete <a href="https://github.com/h5bp/html5-boilerplate/blob/master/.htaccess">.htaccess</a>
file. While this is very nice for a single site they recommend you do
something different for multiple sites at <a href="https://github.com/h5bp/html5-boilerplate/blob/21c614849afc5b518685b68d81d2b0c8f7971f0a/.htaccess#L4-L6">the very top</a>.</p>

<blockquote>
  <p>(!) Using .htaccess files slows down Apache, therefore, if you have access
to the main server config file (usually called httpd.conf), you should add
this logic there: http://httpd.apache.org/docs/current/howto/htaccess.html.</p>
</blockquote>

<p>This got me to their awesome collection of <a href="https://github.com/h5bp/server-configs">server configs</a>
which has their, and in many ways the communities, recommended settings
depending on your webserver. The <a href="https://github.com/h5bp/server-configs-apache">apache configs</a>
have the same <code class="highlighter-rouge">.htaccess</code> file so I decided to dig into how to do this.</p>

<p>They direct you to the <a href="http://httpd.apache.org/docs/current/howto/htaccess.html">apache article</a>
about using <code class="highlighter-rouge">.htaccess</code> files which has a similar comment about their
use.</p>

<blockquote>
  <p>You should avoid using .htaccess files completely if you have access to httpd main server config file
Using .htaccess files slows down your Apache http server. Any directive that you can include in a
.htaccess file is better set in a Directory block, as it will have the same effect with better performance.</p>
</blockquote>

<p>So I decided to set this up on my <a href="http://www.linode.com/?r=c190426bf1ff0f144b48997675bae8b32d339824">Linode VPS</a> which is running Ubuntu 10.04.
As stated in the original file comment they recommend using the
<code class="highlighter-rouge">httpd.conf</code> file for your custom configuration like this. But
<a href="http://stackoverflow.com/a/11687212/902968">apparently</a> that file could be
overwritten on updates of Apache which would be pretty annoying. Luckily
the default Apache config file (<code class="highlighter-rouge">apache2.conf</code> on 10.04) includes the
contents of the <code class="highlighter-rouge">conf.d</code> folder which is in the same location. By
creating a <code class="highlighter-rouge">foo.conf</code> file in that directory Apache should immediately
load its contents. As mentioned in the comment from the Apache site the
custom configuration needs to be wrapped in a <a href="http://httpd.apache.org/docs/current/mod/core.html#directory">Directory</a> block.
The block expects you to provide a path to the files you want to be
affected by the contained configuration. Since I wanted this to work for
all the sites being served by Apache I simply used <code class="highlighter-rouge">/srv/www/*/</code> which
includes my entire sites directory.</p>

<p>Besides the speed increased gained by using a global <code class="highlighter-rouge">.htaccess</code> file
this allows you to have much shorter custom files for site specific
configuration. For example only required configuration for one of my sites
was the <code class="highlighter-rouge">ErrorDocument</code>s. Now my <code class="highlighter-rouge">.htaccess</code> file went from 300+ lines
to</p>

<figure class="highlight"><pre><code class="language-apache" data-lang="apache"><span class="nc">ErrorDocument</span> 403 /403.php
<span class="nc">ErrorDocument</span> 404 /404.php
<span class="nc">ErrorDocument</span> 500 /500.php</code></pre></figure>


  </div>
</article>

<article>
  <header class="seven columns">
    
      <h2><a href="/2013/08/09/os-x-crash-symbolication/">OS X Crash Report Symbolication</a></h2>
    
    <p>
      <time datetime="2013-08-09 13:26:00 -0700" pubdate="pubdate">
        09 Aug 2013
      </time>
      <a class="permalink" title="Permalink" href="/2013/08/09/os-x-crash-symbolication/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>As you may know I write a small OS X called <a href="http://sailforapp.net/">Sail</a>. Over
the past few months that it has been available I've received a few crash reports
about an issue I wasn't able to reproduce. Today I decided I wanted to dive into
them and see if I could at least figure out the root of the issue and fix it
with my next release.</p>

<p>This lead me down the rabbit hole of
<a href="http://lldb.llvm.org/symbolication.html">symbolication</a>, something I personally
hadn't dealt with myself before (since Crashlytics does it for you). I was
hoping I would be able to find something around the internet about this,
unfortunately what I mostly came up with was a lot of iOS related answers that
didn't seem to work the same way and
<a href="http://developer.apple.com/tools/xcode/symbolizingcrashdumps.html">two</a>
<a href="http://developer.apple.com/library/mac/technotes/tn2004/tn2123.html">links</a> to
Apple documentation that have been removed. Other than the process for
symbolicating reports for OS X apps seems to be different than iOS apps which
there is plenty of documentation for (I'm not bitter). Daniel Jalkut has <a href="http://www.red-sweater.com/blog/439/crappy-crash-logs">a
post</a> about these but his
exact method didn't seem to work for me.</p>

<p>Here is what did work for me. For my first abridged crash report I had this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Process:         Sail [35072]
Path:            /Applications/Sail.app/Contents/MacOS/Sail
Load Address:    0x106823000
Identifier:      com.keithsmiley.SailOSX
Version:         4 (1.2.0)
Code Type:       x86_64 (Native)
Parent Process:  launchd [207]

Date/Time:       2013-07-19 16:09:24.097 +0200
OS Version:      Mac OS X 10.8.4 (12E55)
Report Version:  8

Thread 0:
13  Accounts                        0x00007fff839fd1b1 -[ACAccountStore accountTypeWithAccountTypeIdentifier:] + 230
14  Sail                            0x00000001068308f7
15  Sail                            0x0000000106830798
16  Sail                            0x0000000106825249
17  CoreFoundation                  0x00007fff82465eda _CFXNotificationPost + 2554
18  Foundation                      0x00007fff8611b7b6 -[NSNotificationCenter postNotificationName:object:userInfo:] + 64
31  AppKit                          0x00007fff812cc1a3 -[NSApplication run] + 517
32  AppKit                          0x00007fff81270bd6 NSApplicationMain + 869
33  libdyld.dylib                   0x00007fff869d07e1 start + 0

Binary Images:
  0x106823000 - 0x106896fff  com.keithsmiley.SailOSX (1.2.0 - 4) &lt;D1F313B6-21F6-341B-8627-5480C5D1DB20&gt; /Applications/Sail.app/Contents/MacOS/Sail
</code></pre></div></div>

<p>Just glancing at this crash report it's not too difficult to understand a bit
about what was going on. A notification was sent, some methods were called in my
application and then <code class="highlighter-rouge">accountTypeWithAccountTypeIdentifier</code> was called. Based on
the small number of times I call that method I was quickly able to assume where
the issue was but I still wanted to see exactly what methods of mine were being
called first.</p>

<p>This brings me to <code class="highlighter-rouge">atos</code> the command line tool Apple provides to symbolicate
these reports. This is where my experience differs with most of what I found
online. My usage looked like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>atos -arch x86_64 -o Sail.app.dSYM/Contents/Resources/DWARF/Sail -l 0x106823000
</code></pre></div></div>

<p>This uses my dSYM file that was generated with the archive build I submitted to
the app store along with the knowledge that it was running on an x86_64
architecture and the most important part, for me, the load address.</p>

<p>To find my dSYM file that was generated when I did my archive build I simply
noted the version and build number from the crash report, went to the Archives
tab in the Xcode organizer, found the build with the same number, right clicked
and clicked "Show in Finder." This takes you directly to the <code class="highlighter-rouge">.xcarchive</code> file
on disk which you can right click and click "Show Package Contents." From there
I copied my dSYM to the desktop so I didn't overwrite anything unintentionally.</p>

<p>The load address is the starting memory address of your application. The tool
uses this address as an offset to find the correct methods in your symbols. In
the above crash report <code class="highlighter-rouge">Load Address</code> is a provided field. This was the only
report I saw that had that, typically I needed to look under the <code class="highlighter-rouge">Binary Images</code>
section for the address range of my application. In this example it was
<code class="highlighter-rouge">0x106823000 - 0x106896fff</code>.</p>

<p>The <code class="highlighter-rouge">atos</code> command then provides an interactive prompt where you can paste
addresses into the stdin and it will tell you the corresponding methods. Mine
looked like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x00000001068308f7
-[KSAccountsPreferences dealloc] (in Sail) (KSAccountsPreferences.m:77)
0x0000000106830798
-[KSAccountsPreferences viewDidLoad] (in Sail) (KSAccountsPreferences.m:73)
0x0000000106825249
-[KSAppDelegate openAboutWindow:] (in Sail) (KSAppDelegate.m:59)
</code></pre></div></div>

<p>Here I can see that the notification that was being posted was probably an
<code class="highlighter-rouge">NSApplicationDidFinishLaunchingNotification</code> starting off some methods in my
app delegate. I then load the accounts preferences, which would make sense to
call the <code class="highlighter-rouge">ACAccountStore</code> method, but then <code class="highlighter-rouge">dealloc</code> is called. Seeing this was
an immediate red flag since <code class="highlighter-rouge">KSAccountsPreferences</code> should be retained since it
provides information about available accounts to the rest of the application.</p>

<p>I had another crash report from a different issue that was a little bit harder
to parse without symbolicating the methods.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Process:         Sail [47027]
Identifier:      com.keithsmiley.SailOSX
Version:         1.2.0 (4)
Code Type:       X86-64 (Native)
Parent Process:  launchd [45696]
User ID:         502

Application Specific Information:
*** Terminating app due to uncaught exception 'NSRangeException', reason: '*** -[__NSArrayM objectAtIndex:]: index 0 beyond bounds for empty array'
abort() called
terminate called throwing an exception

Application Specific Backtrace 1:
2   CoreFoundation                      0x000000010c5008ec -[__NSArrayM objectAtIndex:] + 252
3   Sail                                0x000000010b838eed Sail + 61165
4   Sail                                0x000000010b838f36 Sail + 61238
5   Sail                                0x000000010b838b19 Sail + 60185
6   Sail                                0x000000010b83785d Sail + 55389
7   libdispatch.dylib                   0x000000010fa07f01 _dispatch_call_block_and_release + 15

Binary Images:
  0x10b82a000 - 0x10b89dff7 +com.keithsmiley.SailOSX (1.2.0 - 4) &lt;47EC2733-B543-31EA-A6AA-9D998FB65803&gt;
</code></pre></div></div>

<p>Obviously this was caused by an invalid access to an array but that's a little harder to track down. So I again used <code class="highlighter-rouge">atos</code> with the dSYM and new memory location.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>atos -arch x86_64 -o Sail.app.dSYM/Contents/Resources/DWARF/Sail -l 0x10b82a000
</code></pre></div></div>

<p>I got this output for my memory addresses</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x000000010b838eed
-[KSAccountsPreferences selectedADNUser] (in Sail) (KSAccountsPreferences.m:238)
0x000000010b838f36
-[KSAccountsPreferences selectTwitterUsername] (in Sail) (KSAccountsPreferences.m:243)
0x000000010b838b19
-[KSAccountsPreferences populateTwitterAccounts] (in Sail) (KSAccountsPreferences.m:211)
0x000000010b83785d
__36-[KSAccountsPreferences viewDidLoad]_block_invoke (in Sail) (KSAccountsPreferences.m:70)
</code></pre></div></div>

<p>This ended up giving me the exact line where out of bounds issue was happening
depending on a certain number of accounts. I noticed that this issue had been
fixed since my last release so I did a <code class="highlighter-rouge">diff</code> on the tag I created for that
specific release with</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git difftool HEAD..1.2.0\(3\)
</code></pre></div></div>

<p>Then in <a href="http://www.kaleidoscopeapp.com/">Kaleidoscope</a> I was able to figure out
what changed had fixed the issue. Just because it's so pretty here is what it
looked like.</p>

<p><img src="/images/symbolication/diff.png" alt="Diff" /></p>

<p>Symbolicating crash reports is definitely vital to tracking down bugs your users
are experiencing when you can't reproduce them yourself. Once you figure out how
it's obviously worth it.</p>


  </div>
</article>

<article>
  <header class="seven columns">
    
      <h2><a href="/2013/05/22/the-best-text-editor/">The 'Best' Text Editor</a></h2>
    
    <p>
      <time datetime="2013-05-22 00:59:00 -0700" pubdate="pubdate">
        22 May 2013
      </time>
      <a class="permalink" title="Permalink" href="/2013/05/22/the-best-text-editor/">&infin;</a>
    </p>
  </header>

  <div class="post ten columns">
    <p>I'm tired of people asking about the 'best' IDE for xyz purpose. The answer to this question is there is no best. The answer is always 'it depends.' Not only does it depend on what you're doing but more importantly it depends on you. It depends on your work flow. It depends tons of other indiscernible factors.</p>

<p>It seems like people think they work in exactly the same way as enough other people. That asking this question will yield a useful result. The truth is that there are far fewer text editors than people who need text editors so it's impossible not to overlap with someone. We misconstrue this overlap in thinking that now this person knows exactly what we want. In reality they just happen to share some arbitrary subset of the way we  work and therefore ended up with the same text editor.</p>

<p>So how can you decide which editor is best for you? Try them. This sounds obvious to you? Good, this article is not for you and you can safely leave now. These days text editors are either free, cheap or have trials. So download them all try them out and see if they make sense to you. Weed out the ones you really hate or the ones that crash and spend a little more time with the remaining editors. Some, like Vim, you may have to spend a little more time with to grasp but this still doesn't seem like a high order.</p>

<p>But please stop asking questions on StackOverflow and similar sites where you expect people to throw their vote into the hat for the 'best' editor and make a decision for yourself.</p>


  </div>
</article>


<!-- Pagination links -->
<div class="pagination ten columns">
  
    <div class="older">
      <span class="pagearrow">&larr;</span>
      <a href="/page3">Older</a>
    </div>
  

  <div class="pagearchive">
    <a href="/archives/">Blog Archive</a>
  </div>

  
    
      <div class="newer">
        <a href="/">Newer</a>
        <span class="pagearrow">&rarr;</span>
      </div>
    
  
</div>

      </section>
    </section>
  </body>
</html>
